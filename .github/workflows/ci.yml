name: CI

on:
  push:
    branches: [ main, APlintegrated ]
  pull_request:
    branches: [ main, APlintegrated ]

permissions:
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest

    env:
      NEXT_PUBLIC_TMDB_READ_ACCESS_TOKEN: ${{ secrets.NEXT_PUBLIC_TMDB_READ_ACCESS_TOKEN }}
      # Fallback to v3 API key if needed
      NEXT_PUBLIC_TMDB_API_KEY: ${{ secrets.NEXT_PUBLIC_TMDB_API_KEY }}
      TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
      TMDB_READ_ACCESS_TOKEN: ${{ secrets.TMDB_READ_ACCESS_TOKEN }}
      MONGODB_URI: ${{ secrets.MONGODB_URI }}
      NEXTAUTH_SECRET: ${{ secrets.NEXTAUTH_SECRET }}
      NEXTAUTH_URL: ${{ secrets.NEXTAUTH_URL }}
      GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
      GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}

    steps:
    - uses: actions/checkout@v4
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        
    - name: Install dependencies
      run: npm install
      
    - name: Lint
      run: npm run lint || echo "Linting failed but continuing" 
      # ^ Remove the "|| echo" part if you want linting to be required to pass
      
    - name: Build
      run: npm run build
      
    - name: Start server on port 3000
      run: |
        echo "Starting Next.js server on port 3000..."
        npm start &
        SERVER_PID=$!
        
        # Wait for server to start
        sleep 15
        
        # Check if server is running
        echo "Checking server health..."
        if curl -f http://localhost:3000 --connect-timeout 10; then
          echo "‚úÖ Server is running at http://localhost:3000"
          echo "‚úÖ Server responded successfully!"
        else
          echo "‚ùå Server health check failed"
          exit 1
        fi
        
        # Show server info
        echo "üöÄ Application is running on:"
        echo "   - Local:   http://localhost:3000"
        echo "   - Network: http://127.0.0.1:3000"
        
        # Keep server running for a bit to simulate real usage
        sleep 10
        
        # Clean up - kill the server process
        kill $SERVER_PID
        echo "üõë Server stopped"
        
    # Add test step when you have tests
    # - name: Test
    #   run: npm test